---
title: "Get started with funbiogeo"
output: rmarkdown::html_vignette
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Get started with funbiogeo}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: inline
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse   = TRUE,
  comment    = "#>",
  fig.width  = 7,
  fig.height = 7,
  out.width  = "100%",
  dpi        = 100
)
```

The aim of the `funbiogeo`package is to help users streamline the workflows in **fun**ctional **biogeo**graphy [@Violle_emergence_2014].
It helps filter sites, species, and traits based on their trait coverages.
It also provide default diagnostic plots and standard tables summarizing input
data. This vignette aims to be an introduction to the most commonly used
functions.

The vignette will be a worked through a real world example using the internal
dataset provided by `funbiogeo`.

```{r setup}
library("funbiogeo")
library("ggplot2")
```


## Provided data

We are interested in mapping the functional traits of mammals of Europe.
We used range maps data
[from the IUCN](https://www.iucnredlist.org/resources/spatial-data-download)
and trait data from the
[PanTHERIA database](https://esapubs.org/archive/ecol/E090/184/)
[@Jones_PanTHERIA_2009].
The initial extraction is available
[on GitHub](https://github.com/FRBCesab/eumammals).

The package `funbiogeo` requires three different data.frame to proceed with the 
analyses:

- the **species x traits** data.frame (`species_traits` in `funbiogeo`)
- the **site x species** data.frame (`site_species` in `funbiogeo`)
- the **site x locations** object (`site_locations` in `funbiogeo`)

You can load the example data using `data(..., package = "funbiogeo")` call:

```{r 'load-datasets'}
data("site_species", package = "funbiogeo")
data("site_locations", package = "funbiogeo")
data("species_traits", package = "funbiogeo")
```


### Species x Traits

This object contains traits values for studied species.
It should be a `data.frame`. The first column should contain species names and
the other columns contain trait values.

Note that we'll be talking about **species** throughout this vignette
and in the arguments of `funbiogeo`, but the package doesn't make any assumption
on the biological level at which species are. It can be individuals,
populations, strains, species, genera, families, etc. The important fact is that
you should have trait data for the level at which you want to work.

Let's examine the `species_traits` data include in the package:

```{r 'preview-species-traits', echo = FALSE}
knitr::kable(head(species_traits, 4), 
             caption   = "First lines of species x traits dataset", 
             align     = c("r", "r", "r", "r", "r", "r"))
```

The first column `species` contains species names, while the next 6 columns
contains the trait values for all species. Note that the species names are 
anonymized because the IUCN data
[cannot be redistributed](https://www.iucnredlist.org/terms/terms-of-use#4.%20No%20Reposting%20or%20Redistribution).

Let's look at a summary of the trait dataset:

```{r summary-trait-dataset}
summary(species_traits)
```

From there we can see that there are 149 included species and some missing trait
values. For example, there we don't have body mass for 26 species.


### Site x Species

This object contains species occurrences/abundance/coverage at sites  
of the study area. It is a `data.frame`. The first column contain site names
while the other columns contains the distribution of species across sites.

Note that here we are talking about sites in an abstract way.
These can be plots, assemblages, of whatever set of species
you're interested in.

The package `funbiogeo` comes with the example dataset `site_species`.
Let's look at it:

```{r 'preview-sites-species', echo = FALSE}
knitr::kable(head(site_species[ , 1:4], 10), 
             caption   = "Format of site x species dataset", 
             align     = c("c", "c", "c", "c"))
```

The example dataset contains the occurrence of the 149 above-mentioned species
across 1505 sites of 0.5째 by 0.5째 resolution.


### Site x Locations

This object contains the geographical location of the sites.
It should be an `sf` object
from the [`sf` package](https://cran.r-project.org/package=sf). The sites can
have arbitrary shapes: points, regular polygons, irregular polygons, or even
line transects! To make sure that your data is well plotted you should specify
the Coordinate Reference System (CRS) of this object.

The package `funbiogeo` comes with the example dataset `site_locations` defining
the location of the 1505 pixels of 0.5째 by 0.5째 resolution.

```{r 'preview-sites-locs', echo = FALSE}
knitr::kable(head(site_locations, 10), 
             caption   = "Format of site x locations dataset", 
             align     = c("r", "r"))
```


## Visualizing the data (diagnostic plots)

Showing trait coverage

Showing species

Showing sites

## Filtering the data

### Filtering trait by species coverage

### Filtering species by trait coverage

### Filtering sites by trait coverage

```{r 'filter-trait-coverage'}
## Get trait coverage ----
sel_sites <- fb_filter_sites_by_trait_coverage(
  site_species, species_traits, threshold_traits_proportion = 1
)

## Preview ----
head(sel_sites[ , 1:4])
```


```{r 'sites-comparison'}
## Original sites ----
nrow(site_species)

## Filtered sites ----
nrow(sel_sites)
```


## Computing Functional Diversity metrics

### Community-Weighted Means

```{r 'compute-cwm'}
data("site_locations")
data("site_species")
data("species_traits")

## Compute CWM ----
cwm <- fb_cwm(site_species, species_traits)

## Preview ----
head(cwm)
```


### Other functional diversity metrics

`fundiversity`, `funrar`, `mFD`



## Putting Functional Diversity on the map

### Map of environment


```{r 'map-tavg', dev='png'}
## Read raster ----
tavg <- system.file("extdata", "annual_mean_temp.tif", package = "funbiogeo")
tavg <- terra::rast(tavg)

## Map of raster ----
fb_map_raster(tavg)
```


```{r 'map-tavg-custom'}
fb_map_raster(tavg) + 
  scale_fill_distiller("Temperature", palette = "Spectral") +
  theme(legend.position = "bottom") + 
  ggtitle("Mean annual temperature in Pennsylvania")
```


```{r 'composition-map', dev='png'}
library("patchwork")

## Read raster ----
tavg <- system.file("extdata", "annual_mean_temp.tif", package = "funbiogeo")
tavg <- terra::rast(tavg)

prec <- system.file("extdata", "annual_tot_prec.tif", package = "funbiogeo")
prec <- terra::rast(prec)

## Individual Maps ----
x <- fb_map_raster(tavg, legend.position = "none") + 
  scale_fill_distiller("Temperature", palette = "Spectral")

y <- fb_map_raster(prec) + 
  scale_fill_distiller("Precipitation", direction = 1)

## Arrangement ----
figure <- x / y

figure + 
  plot_annotation(title = "Pennsylvania", 
                  theme = theme(plot.title = element_text(face = "bold"))) & 
  theme_classic() &
  theme(text = element_text('mono'))
```


### Map of indices

[...]


```{r 'upscale-richness', dev='png'}
## Upscale to grid ----
ras_richness <- fb_aggregate_site_data(site_locations = site_locations, 
                                       site_data      = rich_env, 
                                       agg_grid       = tavg)

ras_richness
```

```{r 'map-richness', dev='png'}
fb_map_raster(ras_richness[[1]])
```

```{r 'map-richness-custom', dev='png'}
fb_map_raster(ras_richness[[1]]) + 
  scale_fill_distiller("Number of species", palette = "Spectral") +
  theme(legend.position = "bottom") + 
  ggtitle("Trees species richness in Pennsylvania")
```


## References
