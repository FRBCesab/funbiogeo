---
title: "Get started with funbiogeo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started with funbiogeo}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: inline
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse   = TRUE,
  comment    = "#>",
  fig.width  = 7,
  fig.height = 7,
  out.width  = "100%",
  dpi        = 300
)
```

The aim of the `funbiogeo`package is to help users with analyses in **Fun**ctional 
**biogeo**graphy (Violle *et al.* 2014). It helps to load and combine data, 
computing trait coverage, as well as computing functional diversity indices, 
drawing maps, correlate them with the environment, and upscaling assemblages.

```{r setup}
library("funbiogeo")
library("ggplot2")
```


## Initial needed data

The package `funbiogeo` requires three different datasets to proceed with the 
analyses:

- the **site x locations** dataset (example dataset: `site_locations`)
- the **site x species** dataset (example dataset: `site_species`)
- the **species x traits** dataset (example dataset: `species_traits`)

Let's take a look at each of these datasets.


### Site x Locations



This dataset contains spatial coordinates of sites (points) of the study area. 
It can be either a `matrix` or a `data.frame` and row names must contain sites 
names. It must contain at least two columns: the longitude and the latitude of 
sites. This dataset must contain unique sites. Additional columns are accepted 
must will be ignored by `funbiogeo`.

The package `funbiogeo` comes with the example dataset `site_locations`.


```{r 'load-sites-locs'}
## Load site x locations example dataset ----
data("site_locations", package = "funbiogeo")
```

```{r 'preview-sites-locs', echo = FALSE}
knitr::kable(head(site_locations, 10), 
             caption   = "Format of site x locations dataset", 
             align     = c("r", "r"),
             row.names = TRUE)
```

```{r 'print-sites-ids-1'}
## Row names contain sites names ----
rownames(site_locations)[1:4]
```

To create your own site x locations dataset you can use the function 
`fb_format_site_locations()`. See below the section ***Long format***.



### Site x Species

This dataset contains species occurrences/abundance/coverage at sites (points) 
of the study area. It can be either a `matrix` or a `data.frame` and row names 
must contain sites names. Columns must contain only species distribution 
information and sites must be unique. No additional columns are accepted.

The package `funbiogeo` comes with the example dataset `site_species`.

```{r 'load-sites-species'}
## Load site x species example dataset ----
data("site_species", package = "funbiogeo")
```

```{r 'preview-sites-species', echo = FALSE}
knitr::kable(head(site_species[ , 1:4], 10), 
             caption   = "Format of site x species dataset", 
             align     = c("c", "c", "c", "c"),
             row.names = TRUE)
```

```{r 'print-sites-ids-2'}
## Row names contain sites names ----
rownames(site_species)[1:4]
```

```{r 'print-species-ids-1'}
## Column names contain species names ----
colnames(site_species)[1:4]
```

To create your own site x species dataset you can use the function 
`fb_format_site_species()`. See below the section ***Long format***.



### Species x Traits

This dataset contains traits values for studied species. It can be either a 
`matrix` or a `data.frame` and row names must contain species names. Columns 
must contain only traits variables and species must be unique. No additional 
columns are accepted.

Note that traits values cannot vary across sites for a given species.

The package `funbiogeo` comes with the example dataset `species_traits`.

```{r 'load-species-traits'}
## Load species x traits example dataset ----
data("species_traits", package = "funbiogeo")
```

```{r 'preview-species-traits', echo = FALSE}
knitr::kable(head(species_traits, 4), 
             caption   = "Format of species x traits dataset", 
             align     = c("r", "r", "r", "r", "r", "r"),
             row.names = TRUE)
```

```{r 'print-species-ids-2'}
## Row names contain species names ----
rownames(species_traits)[1:4]
```

```{r 'print-traits-ids-1'}
## Column names contain traits names ----
colnames(species_traits)
```

To create your own species x traits dataset you can use the function 
`fb_format_species_traits()`. See below the section ***Long format***.



### Long format

If your data are not spread into three datasets you can use the functions
`fb_format_*()` to create these specific datasets. This implies that your data 
are structured into a long table, i.e. one row corresponds to the 
occurrence/abundance/coverage of one species at one site. This also implies that
some variables are repeated across the table (e.g. sites coordinates, species 
traits).

Let's take an example

```{r 'load-raw-dataset'}
## Path to example raw dataset ----
filename <- system.file("extdata", "raw_mammals_data.csv", package = "funbiogeo")

## Read CSV file ----
all_data <- read.csv(filename)
```

```{r 'preview-raw-dataset', echo = FALSE}
knitr::kable(head(all_data, 10), 
             caption   = "Long table example", 
             align     = c("c", "r", "r", "l", "c", "r", "r", "r", "r", "r", "r"),
             row.names = FALSE)
```

<br />

**Formatting site x locations data**

The function `fb_format_site_locations()` extracts sites coordinates from this
long table to create the site x locations dataset. Note that one site must have
one unique longitude x latitude value.

```{r 'format-sites-locs'}
## Format site x locations data ----
site_locations <- fb_format_site_locations(input_data =  all_data, 
                                           site       = "site", 
                                           longitude  = "longitude", 
                                           latitude   = "latitude",
                                           na_rm      = FALSE)

## Preview ----
head(site_locations)
```

<br />

**Formatting site x species data**

The function `fb_format_site_species()` extracts species 
occurrence/abundance/coverage from this long table to create the 
site x species dataset. Note that one species must have been observed one time 
at one site (the package `funbiogeo` does not yet consider temporal survey).

```{r 'format-sites-species'}
## Format site x species data ----
site_species <- fb_format_site_species(data       = all_data, 
                                       site       = "site", 
                                       species    = "species", 
                                       value      = "count",
                                       na_to_zero = TRUE)

## Preview ----
head(site_species)
```

<br />

**Formatting species x traits data**

The function `fb_format_species_traits()` extracts species traits values from 
this long table to create the species x traits dataset. Note that one species 
must have one unique trait value (no trait variation across sites allowed).

```{r 'format-species-traits'}
## Format species x traits data ----
species_traits <- fb_format_species_traits(data    = all_data, 
                                           species = "species", 
                                           traits  = c("adult_body_mass", "gestation_length", 
                                                       "litter_size", "max_longevity",
                                                       "sexual_maturity_age", "diet_breadth"))

## Preview ----
species_traits
```

## Computing Trait Coverages

a.k.a, how well are sites covered given the trait data I have?


```{r 'load-datasets'}
data("site_species", package = "funbiogeo")
data("site_locations", package = "funbiogeo")
data("species_traits", package = "funbiogeo")
```


[...]





### Compute trait coverage



[...]


```{r 'get-trait-coverage'}
## Get trait coverage ----
cover <- fb_get_coverage(site_species, species_traits)

## Preview ----
head(cover)
```



[...]



### Filter sites by trait coverage



[...]



```{r 'filter-trait-coverage'}
## Get trait coverage ----
sel_sites <- fb_filter_coverage(site_species, species_traits, coverage_threshold = 1)

## Preview ----
head(sel_sites[ , 1:4])
```


```{r 'sites-comparison'}
## Original sites ----
nrow(site_species)

## Filtered sites ----
nrow(sel_sites)
```



## Diversity metrics

[...]

### Species Richness

```{r 'species-richness'}
## Compute species richness ----
richness <- apply(site_species, 1, function(x) sum(ifelse(x > 0, 1, 0)))

## Convert to data frame ----
richness <- data.frame("n_species" = richness)
rownames(richness) <- rownames(site_species)

## Preview ----
head(richness)
```

### Community-Weighted Means

[...]


```{r 'compute-cwm'}
data("site_locations")
data("site_species")
data("species_traits")

## Compute CWM ----
cwm <- fb_cwm(site_species, species_traits)

## Preview ----
head(cwm)
```


### Other functional diversity metrics

`fundiversity`, `funrar`, `mFD`

[...]


## Relation with environment

[...]

```{r 'load-rasters'}
## Available climate rasters ----
prec <- system.file("extdata", "annual_tot_prec.tif", package = "funbiogeo")
tavg <- system.file("extdata", "annual_mean_temp.tif", package = "funbiogeo")

## Import climate rasters ----
layers <- terra::rast(c(tavg, prec))

## Preview ----
layers
```

[...]

```{r 'extract-rasters'}

site_locations <- site_locations[!duplicated(site_locations),]
site_locations[["site"]] <- rownames(site_locations)
rownames(site_locations) <- NULL
site_locations <- sf::st_as_sf(site_locations, coords = 1:2, crs = 4326)

## Extract environment at sites ----
sites_env <- fb_get_environment(site_locations, layers)

## Preview ----
head(sites_env)
```

[...]

```{r 'relation-w-environment'}
## Append information ----
rich_env <- merge(richness, sites_env, by.x = "row.names", by.y = "site")

## Preview ----
head(rich_env)
```

```{r 'biplot'}
biplot <- ggplot(rich_env, aes(x = annual_mean_temp, y = n_species)) +
  geom_point() +
  theme_classic() +
  labs(x = "Annual mean temperature", y = "Species richness")
biplot
```

```{r 'biplot-trend'}
biplot + geom_smooth(method = "lm")
```



## Visualization

### Trait coverage

[...]

### Map of environment

[...]



```{r 'map-tavg'}
## Read raster ----
tavg <- system.file("extdata", "annual_mean_temp.tif", package = "funbiogeo")
tavg <- terra::rast(tavg)

## Map of raster ----
fb_map_raster(tavg)
```


```{r 'map-tavg-custom'}
fb_map_raster(tavg) + 
  scale_fill_distiller("Temperature", palette = "Spectral") +
  theme(legend.position = "bottom") + 
  ggtitle("Mean annual temperature in Pennsylvania")
```


```{r 'composition-map'}
library("patchwork")

## Read raster ----
tavg <- system.file("extdata", "annual_mean_temp.tif", package = "funbiogeo")
tavg <- terra::rast(tavg)

prec <- system.file("extdata", "annual_tot_prec.tif", package = "funbiogeo")
prec <- terra::rast(prec)

## Individual Maps ----
x <- fb_map_raster(tavg, legend.position = "none") + 
  scale_fill_distiller("Temperature", palette = "Spectral")

y <- fb_map_raster(prec) + 
  scale_fill_distiller("Precipitation", direction = 1)

## Arrangement ----
figure <- x / y

figure + 
  plot_annotation(title = "Pennsylvania", 
                  theme = theme(plot.title = element_text(face = "bold"))) & 
  theme_classic() &
  theme(text = element_text('mono'))
```


### Map of indices

[...]


```{r 'upscale-richness'}
## Upscale to grid ----
rownames(rich_env) <- rich_env[ , 1]
rich_env <- rich_env[ , "n_species", drop = FALSE]

ras_richness <- fb_aggregate_site_data(site_locations = site_locations, 
                                       site_data      = rich_env, 
                                       agg_grid       = tavg)

ras_richness
```

```{r 'map-richness'}
fb_map_raster(ras_richness)
```

```{r 'map-richness-custom'}
fb_map_raster(ras_richness) + 
  scale_fill_distiller("Number of species", palette = "Spectral") +
  theme(legend.position = "bottom") + 
  ggtitle("Trees species richness in Pennsylvania")
```


## References

Violle C, Reich, PB Pacala SW, _et al._ (2014) 
The emergence and promise of functional biogeography. 
*Proceedings of the National Academy of Sciences*, **111**, 13690--13696. 
DOI: [10.1073/pnas.1415442111](https://doi.org/10.1073/pnas.1415442111)
