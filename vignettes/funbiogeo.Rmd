---
title: "Get started with funbiogeo"
output: rmarkdown::html_vignette
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Get started with funbiogeo}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: inline
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse   = TRUE,
  comment    = "#>",
  fig.width  = 7,
  fig.height = 7,
  out.width  = "100%",
  dpi        = 100
)
```

The aim of the `funbiogeo`package is to help users streamline the workflows in **fun**ctional **biogeo**graphy [@Violle_emergence_2014].
It helps filter sites, species, and traits based on their trait coverages.
It also provide default diagnostic plots and standard tables summarizing input
data. This vignette aims to be an introduction to the most commonly used
functions.

The vignette will be a worked through a real world example using the internal
dataset provided by `funbiogeo`.

```{r setup}
library("funbiogeo")
library("ggplot2")
```

## Provided data

We are interested in mapping the functional traits of mammals of Europe.
We used range maps data
[from the IUCN](https://www.iucnredlist.org/resources/spatial-data-download)
and trait data from the
[PanTHERIA database](https://esapubs.org/archive/ecol/E090/184/)
[@Jones_PanTHERIA_2009].
The initial extraction is available
on [GitHub](https://github.com/FRBCesab/eumammals).

The package `funbiogeo` requires three different datasets to proceed with the 
analyses:

- the **species x traits** `data.frame` (`species_traits` in `funbiogeo`)
- the **site x species** `data.frame` (`site_species` in `funbiogeo`)
- the **site x locations** object (`site_locations` in `funbiogeo`)

You can load the example data using `data(..., package = "funbiogeo")` call:

```{r load-datasets}
data("site_species", package = "funbiogeo")
data("site_locations", package = "funbiogeo")
data("species_traits", package = "funbiogeo")
```


### Species x Traits

This object contains traits values for studied species.
It should be a `data.frame`. The first column should contain species names and
the other columns contain trait values.

Note that we'll be talking about **species** throughout this vignette
and in the arguments of `funbiogeo`, but the package doesn't make any assumption
on the biological level. It can be individuals, populations, strains, species,
genera, families, etc. The important fact is that you should have trait data
for the level at which you want to work.

Let's examine the `species_traits` data included in the package:

```{r preview-species-traits, echo = FALSE}
knitr::kable(head(species_traits, 4), 
             caption   = "First lines of species x traits dataset", 
             align     = c("r", "r", "r", "r", "r", "r"))
```

The first column **`"species"`** contains species names, while the next 6
columns contain the trait values for all species. Note that the species names
are anonymized because the IUCN data
[cannot be redistributed](https://www.iucnredlist.org/terms/terms-of-use#4.%20No%20Reposting%20or%20Redistribution).

Let's look at a summary of the trait dataset:

```{r summary-trait-dataset}
summary(species_traits)
```

From there we can see that there are 149 included species and some missing trait
values. For example, there we don't have body mass for 26 species.

Note that to use your own species by traits `data.frame`, it should follow
similar structure with the first column being named **`"species"`** and the
other ones containing traits.


### Site x Species

This object contains species occurrences/abundance/coverage at sites  
of the study area. It is a `data.frame`. The first column, **`"site"`**,
contains site names while the other columns contains the abundance of each
species across sites.

Note that here we are talking about sites in an abstract way.
These can be plots, assemblages, of whatever set of species
you're interested in.

The package `funbiogeo` comes with the example dataset `site_species`.
Let's look at it:

```{r preview-sites-species, echo = FALSE}
knitr::kable(head(site_species[ , 1:4], 10), 
             caption   = "Format of site x species dataset", 
             align     = c("c", "c", "c", "c"))
```

The example dataset contains the occurrence of the 149 above-mentioned species
across 1,505 sites (grid cells of 0.5째 x 0.5째 resolution).

Note that to use your own site by species `data.frame`, it should follow similar
structure with the first column being named **`"sites"`** and the other ones
containing presence information of species across sites.

### Site x Locations

This object contains the geographical location of the sites.
It should be an `sf` object
from the [`sf` package](https://cran.r-project.org/package=sf). The sites can
have arbitrary shapes: points, regular polygons, irregular polygons, or even
line transects! To make sure that your data is well plotted you should specify
the Coordinate Reference System (CRS) of this object.

The package `funbiogeo` comes with the example dataset `site_locations` defining
the location of the 1,505 sites (grid cells of 0.5째 x 0.5째 resolution).
It contains the names of the site in its first column **`"site"`**:

```{r preview-sites-locs}
site_locations
```

Note that to use your own site locations object, it should follow similar
structure with the first column being named **`"sites"`**.


## Visualizing the data (diagnostic plots)

`funbiogeo` provides many functions to display the data to help the user select
specific traits, species, and/or sites. We are going to detail some of them
in this section. We call them *diagnostic plots* because they help us
to have an overview of our dataset **prior** to the analyses.

### Trait completeness per species

A first way to visualize our `data.frame` is to look at the proportion of species
with non-missing traits using the `fb_plot_number_species_by_trait()` function.
It takes the species by trait `data.frame` as input.

```{r fig-plot-sp-by-trait}
fb_plot_number_species_by_trait(species_traits)
```

This plot shows us the number of species (along the x-axis) in function of 
the trait name (along the y-axis). The number of concerned species is shown at
the bottom of the plot while the corresponding proportion of species
(compared to all the species included in the trait dataset) is indicated as
a secondary x-axis at the top. The proportion of species concerned is shown at
the right of each point. For example, in our example dataset, 82.6% species have
a non-NA adult body mass.

The function also include a way to provide a target proportion of species as
the second argument. It will display the proportion as a dark red dashed line.

For example, if we want to visualize which traits cover more than 75%
of the species:

```{r fig-plot-sp-by-trait-prop}
fb_plot_number_species_by_trait(species_traits, threshold_species_proportion = 0.75)
```

The top number shows the corresponding number of species.


### Number of Traits per Species

Another way to filter the data would be to select certain species that
have at least a certain number of traits. This can be visualized using the
`fb_plot_number_traits_by_species()` function. Similarly to the above-mentioned
function, it takes the species x traits `data.frame` as the first argument:

```{r fig-plot-trait-by-sp}
fb_plot_number_traits_by_species(species_traits)
```

The plot shows the number (bottom axis) and the proportion (top axis) of
species covered by a specific number of traits (0 to 6 in our example).

  
## Filtering the data

Now that we displayed the diagnostic plots, we can decide thresholds and filter
our data for our following analyses.

### Filter trait by species coverage

We want to select the traits that cover at least 75% of the species. 
To do that we can use the `fb_filter_traits_by_species_coverage()` function.
The function takes the species by traits `data.frame` and outputs the same dataset
but with the traits filtered (so with less columns). The second argument
`threshold_species_proportion` is the threshold proportion of species covered:

```{r filter-traits-by-species}
# Initial dimension of the input data
dim(species_traits)

# Filter traits 
red_sp_traits <- fb_filter_traits_by_species_coverage(
  species_traits, threshold_species_proportion =  0.75
)

dim(red_sp_traits)

# The reduced data set now has fewer trait columns
head(red_sp_traits)
```


### Filter species by trait coverage

Similarly you could filter species by their trait coverage. For example we would
like to make sure that the species we filtered previously so that they show
at least one of the two traits selected above.
We can use the function `fb_filter_species_by_trait_coverage()` with
the species x traits `data.frame` as the first argument and the second argument
the proportion of traits covered by species.

```{r filter-species-by-traits}
# Filter species with at least 50% of included (two traits)
# at least one trait
red_sp_traits_2 <- fb_filter_species_by_trait_coverage(
  red_sp_traits, threshold_traits_proportion = 0.5
)

head(red_sp_traits_2)

dim(red_sp_traits_2)
```

We thus have selected 2 traits that cover at least 75% of the species and
127 species which have known values for these two traits.


### Filter sites by trait coverage

Now that we have filtered our traits and species of interest we need to filter
the sites. Similarly to above the function is
`fb_filter_sites_by_trait_coverage()` it takes as two first arguments
the site x species `data.frame` and the species x traits `data.frame`. The third
argument is `threshold_traits_proportion` that indicates the percent coverage
of traits to filter each site. Note that this coverage is weighted by
the occurrence, abundance, or cover depending on the content
of the site x species `data.frame`.

```{r filter-trait-coverage}
# Initial site x species data
dim(site_species)

# Filter sites with at least 90% species covered
filt_sites <- fb_filter_sites_by_trait_coverage(
  site_species, red_sp_traits_2, threshold_traits_proportion = 0.9
)

# Filtered sites
dim(filt_sites)

filt_sites[1:4, 1:4]
```

Now we selected 1,268 sites out of 1,505.


## Computing Functional Diversity metrics

Now that `funbiogeo` helped us filter our data we can use them to proceed with
our analyses. We can for example compute functional diversity indices.
This where you should use your preferred packages to compute functional
diversity indices like [`mFD`](https://cran.r-project.org/package=mFD),
[`betapart`](https://cran.r-project.org/package=betapart), or
[`hypervolume`](https://cran.r-project.org/package=hypervolume).

For the sake of the example we included a single function in `funbiogeo`
to compute Community-Weighted Mean [CWM, @Garnier_Plant_2004] named `fb_cwm()`.
The CWM is the abundance-weighted average trait per site. We'll be using it in
the following section but feel free to use any other functional diversity
package.


### Community-Weighted Mean (CWM)

To compute the CWM you can use the `fb_cwm()` function, it takes
the site x species `data.frame` and species x traits `data.frame` as arguments.

```{r compute-cwm}
cwm <- fb_cwm(filt_sites, red_sp_traits_2)

head(cwm)
```
It outputs a `data.frame` with 3 columns: `site` the first one shows the site
name as provided in the input site x species `data.frame`, `trait`
which indicates the trait name on which the CWM is computed,
and `cwm` which shows the value of the CWM.


## Putting Functional Diversity on the map

### Map of environment

```{r map-tavg, dev = 'png'}
## Read raster ----
tavg <- system.file(
  "extdata", "annual_mean_temp.tif", package = "funbiogeo"
)
tavg <- terra::rast(tavg)

## Map of raster ----
fb_map_raster(tavg)
```


```{r map-tavg-custom}
fb_map_raster(tavg) + 
  scale_fill_distiller("Temperature", palette = "Spectral") +
  theme(legend.position = "bottom") + 
  ggtitle("Mean annual temperature in Pennsylvania")
```


```{r composition-map, dev = 'png'}
library("patchwork")

## Read raster ----
tavg <- system.file("extdata", "annual_mean_temp.tif", package = "funbiogeo")
tavg <- terra::rast(tavg)

prec <- system.file("extdata", "annual_tot_prec.tif", package = "funbiogeo")
prec <- terra::rast(prec)

## Individual Maps ----
x <- fb_map_raster(tavg, legend.position = "none") + 
  scale_fill_distiller("Temperature", palette = "Spectral")

y <- fb_map_raster(prec) + 
  scale_fill_distiller("Precipitation", direction = 1)

## Arrangement ----
figure <- x / y

figure + 
  plot_annotation(title = "Pennsylvania", 
                  theme = theme(plot.title = element_text(face = "bold"))) & 
  theme_classic() &
  theme(text = element_text(family = "mono"))
```


### Map of indices


## References
